{"version":3,"sources":["assets\\Scripts\\ECS\\Systems\\NavSystem.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\r\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/typescript.html\r\n// Learn Attribute:\r\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nimport { EventManager } from \"../../../FrameWork/manager/EventManager\";\r\nimport { GameUI } from \"../../EventName\";\r\nimport BaseComponent from \"../Components/BaseComponent\";\r\nimport NavComponent from \"../Components/NavComponent\";\r\nimport TransformComponent from \"../Components/TransformComponent\";\r\n\r\nconst {ccclass, property} = cc._decorator;\r\n\r\n@ccclass\r\nexport default class NavSystem extends cc.Component {\r\n    private static _instance:NavSystem=null\r\n    onLoad () {\r\n        if(null===NavSystem._instance){\r\n            NavSystem._instance=this\r\n        }\r\n        else{\r\n            this.destroy()\r\n            return\r\n        }\r\n    }\r\n\r\n    public static getInstance():NavSystem{\r\n        return NavSystem._instance\r\n    }\r\n\r\n    onEnemyUpdate(dt:number,navComponent:NavComponent,baseComponent:BaseComponent,transformComponent:TransformComponent){\r\n        if(navComponent.curTime>0){\r\n            navComponent.curTime-=dt;\r\n            baseComponent.gameObject.x=navComponent.vx*dt+transformComponent.x;\r\n            baseComponent.gameObject.y=navComponent.vy*dt+transformComponent.y;\r\n            transformComponent.x=baseComponent.gameObject.x;\r\n            transformComponent.y=baseComponent.gameObject.y;\r\n            return;\r\n        }\r\n        if(navComponent.curIndex>=navComponent.path.length-1){\r\n            return;\r\n        }\r\n        let curPos:cc.Vec2=navComponent.path[navComponent.curIndex];\r\n        let nextPos:cc.Vec2=navComponent.path[navComponent.curIndex+1];\r\n        let dx=nextPos.x-curPos.x;\r\n        let dy=nextPos.y-curPos.y;\r\n        let dis=Math.sqrt(dx*dx+dy*dy);\r\n        navComponent.vx=dx/dis*navComponent.speed;\r\n        navComponent.vy=dy/dis*navComponent.speed;\r\n        navComponent.curTime=dis/navComponent.speed;\r\n        navComponent.curIndex++;\r\n        if(navComponent.curIndex>=navComponent.path.length-1){\r\n            EventManager.getInstance().emit(GameUI.on_player_attacked,{hurt:1})\r\n        }\r\n    }\r\n\r\n    onActorUpdate(dt:number,navComponent:NavComponent,baseComponent:BaseComponent,transformComponent:TransformComponent){\r\n        if(navComponent.curTime>0){\r\n            navComponent.curTime-=dt;\r\n            baseComponent.gameObject.x=navComponent.vx*dt+transformComponent.x;\r\n            baseComponent.gameObject.y=navComponent.vy*dt+transformComponent.y;\r\n            transformComponent.x=baseComponent.gameObject.x;\r\n            transformComponent.y=baseComponent.gameObject.y;\r\n\r\n            if (navComponent.vx < 0) {\r\n                baseComponent.gameObject.getChildByName(\"anim\").scaleX = -1;\r\n            }\r\n            else {\r\n                baseComponent.gameObject.getChildByName(\"anim\").scaleX = 1;\r\n            }\r\n\r\n            return;\r\n        }\r\n        if(navComponent.curIndex>=navComponent.path.length-1){\r\n            return;\r\n        }\r\n        let curPos:cc.Vec2=navComponent.path[navComponent.curIndex];\r\n        let nextPos:cc.Vec2=navComponent.path[navComponent.curIndex+1];\r\n        let dx=nextPos.x-curPos.x;\r\n        let dy=nextPos.y-curPos.y;\r\n        let dis=Math.sqrt(dx*dx+dy*dy);\r\n        navComponent.vx=dx/dis*navComponent.speed;\r\n        navComponent.vy=dy/dis*navComponent.speed;\r\n        navComponent.curTime=dis/navComponent.speed;\r\n        navComponent.curIndex++;\r\n    }\r\n}\r\n"]}