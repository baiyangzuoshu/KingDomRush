{"version":3,"sources":["assets\\Scripts\\ECS\\Systems\\AnimateSystem.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/life-cycle-callbacks.html\n\nimport { ResManagerPro } from \"../../../FrameWork/manager/ResManagerPro\";\nimport GameDataManager from \"../../Data/GameDataManager\";\nimport { AnimateState, TowerType } from \"../../Enum\";\nimport FrameAnimate from \"../../Tools/FrameAnimate\";\nimport AnimateComponent from \"../Components/AnimateComponent\";\nimport AttackComponent from \"../Components/AttackComponent\";\nimport BaseComponent from \"../Components/BaseComponent\";\nimport RoleComponent from \"../Components/RoleComponent\";\nimport ECSManager from \"../ECSManager\";\nimport ECSUtil from \"../ECSUtil\";\nimport EnemyEntity from \"../Entities/EnemyEntity\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class AnimateSystem extends cc.Component {\n\n    private static _instance:AnimateSystem=null\n    onLoad () {\n        if(null===AnimateSystem._instance){\n            AnimateSystem._instance=this\n        }\n        else{\n            this.destroy()\n            return\n        }\n    }\n\n    public static getInstance():AnimateSystem{\n        return AnimateSystem._instance;\n    }\n\n    async onTowerUpdate(dt:number,towerRoleComponent:RoleComponent,arrowAnimateComponent:AnimateComponent,arrowBaseComponent:BaseComponent,towerAttackComponent:AttackComponent){\n        if(TowerType.Arrow==towerRoleComponent.type){\n            await this.onArrowUpdate(dt,arrowAnimateComponent,arrowBaseComponent,towerAttackComponent);\n        }\n    }\n\n    async onArrowUpdate(dt:number,arrowAnimateComponent:AnimateComponent,arrowBaseComponent:BaseComponent,towerAttackComponent:AttackComponent){\n        let man=arrowBaseComponent.gameObject.getChildByName(\"rhs\");\n\n        var f_anim = man.getComponent(FrameAnimate);\n        if (!f_anim) {\n            f_anim = man.addComponent(FrameAnimate);\n        }\n        let w_dst_pos=arrowAnimateComponent.dstPos;\n        var w_pos = man.convertToWorldSpaceAR(cc.v2(0, 0));\n        // var dir = cc.pSub(w_dst_pos, w_pos);\n        var dir = w_dst_pos.sub(w_pos);\n        // 判断当前是要播放上，还是下\n        if (dir.y > 0) { // 上的动画\n            let up_anim:cc.SpriteFrame[]=[];\n            for(let i=1;i<=4;i++){\n                let sf=await ResManagerPro.Instance.IE_GetAsset(\"textures\",\"game_scene/tower/arrow_tower/arrow1/arrow_up_0\"+i,cc.SpriteFrame) as cc.SpriteFrame;\n                up_anim.push(sf);\n            }\n            f_anim.sprite_frames = up_anim;\n            f_anim.duration = 0.1;\n            f_anim.play_once(function(){\n                //this._set_anim_idle(man, 0);\n            }.bind(this));\n        }\n        else { // 下的动画\n            let down_anim:cc.SpriteFrame[]=[];\n            for(let i=1;i<=4;i++){\n                let sf=await ResManagerPro.Instance.IE_GetAsset(\"textures\",\"game_scene/tower/arrow_tower/arrow1/arrow_down_0\"+i,cc.SpriteFrame) as cc.SpriteFrame;\n                down_anim.push(sf);\n            }\n            f_anim.sprite_frames = down_anim;\n            f_anim.duration = 0.1;\n            f_anim.play_once(function(){\n                //this._set_anim_idle(man, 1);\n            }.bind(this));\n        }\n        //end \n        towerAttackComponent.enemyID = arrowAnimateComponent.id;\n        arrowAnimateComponent.state=AnimateState.stop;\n    }\n\n    async onBulletUpdate(dt:number,bulletRoleComponent:RoleComponent,bulletAnimateComponent:AnimateComponent,\n        bulletAttackComponent:AttackComponent,bulletBaseComponent:BaseComponent){\n        if(TowerType.Arrow==bulletRoleComponent.type){\n            await this.onArrowBulletUpdate(dt,bulletRoleComponent,bulletAnimateComponent,bulletAttackComponent,bulletBaseComponent);\n        }\n    }\n\n    async onArrowBulletUpdate(dt:number,bulletRoleComponent:RoleComponent,bulletAnimateComponent:AnimateComponent,\n        bulletAttackComponent:AttackComponent,bulletBaseComponent:BaseComponent){\n\n        let speed = GameDataManager.getInstance().arrow_bullet_params[bulletRoleComponent.level - 1].speed;\n        let attack = GameDataManager.getInstance().arrow_bullet_params[bulletRoleComponent.level - 1].attack;\n        let enemyEntity:EnemyEntity=ECSManager.getInstance().getEnemyEntityByID(bulletAttackComponent.enemyID);\n        let shoot_enemy = enemyEntity.baseComponent.gameObject;//enemy;\n        let anim=bulletBaseComponent.gameObject.getChildByName(\"anim\")\n        var start_pos = bulletBaseComponent.gameObject.parent.convertToNodeSpaceAR(bulletAnimateComponent.srcPos);\n        var dst_pos = bulletBaseComponent.gameObject.parent.convertToNodeSpaceAR(bulletAnimateComponent.dstPos);\n        \n        // 发射的时候调整我们角度,设置好位置\n        bulletBaseComponent.gameObject.setPosition(start_pos);\n        anim.angle = 270;\n        // end  \n        // 创建一个贝塞尔的action来控制我们的子弹的发射\n        // var dir = cc.pSub(w_dst_pos, w_start_pos);\n        var dir = bulletAnimateComponent.dstPos.sub(bulletAnimateComponent.srcPos);\n\n        // var len = cc.pLength(dir);\n        var len = (dir.mag());\n        var time = len / speed;\n\n        var after_pos = cc.v2(0,-29);//actor.position_after_time(time);\n        let w_dst_pos = shoot_enemy.convertToWorldSpaceAR(after_pos);\n        dst_pos = bulletBaseComponent.gameObject.parent.convertToNodeSpaceAR(w_dst_pos);\n        // end \n        // 求贝塞尔曲线的控制点，中点，然后拉高xxxxx\n        var ctrl_x;\n        var ctrl_y;\n        \n        // if (Math.abs(dir.x) <= 10 && dir.y < 0) {\n        if (0) {\n            ctrl_y = (start_pos.y + dst_pos.y) * 0.5;\n            if (start_pos.x > dst_pos.x) {\n                ctrl_x = dst_pos.x;\n                // ctrl_x -= 20;\n            }\n            else {\n                ctrl_x = dst_pos.x;\n                // ctrl_x += 20;\n            }\n        }\n        else {\n            ctrl_x = (start_pos.x + dst_pos.x) * 0.5;\n            ctrl_y = (dst_pos.y > start_pos.y) ? dst_pos.y : start_pos.y;\n            ctrl_y += 40;\n        }\n        // end \n        var ctrl_point_set = [cc.v2(ctrl_x, ctrl_y), cc.v2(ctrl_x, ctrl_y), dst_pos];\n        var bto_action = cc.bezierTo(time, ctrl_point_set);\n        // this.node.runAction(bto_action); // 发射到目标点;\n        // 换图，把这个完整的键，换成我们的半截键\n        let decal_arrow_sprite_frame:cc.SpriteFrame=await ResManagerPro.Instance.IE_GetAsset(\"textures\",\"game_scene/tower/arrow_tower/bullet/decal_arrow\",cc.SpriteFrame) as cc.SpriteFrame;\n        var func = cc.callFunc(function(){\n            var s = anim.getComponent(cc.Sprite);\n            s.spriteFrame = decal_arrow_sprite_frame;\n            ECSUtil.getInstance().on_arrowBullet_shoot(attack,enemyEntity.unitComponent,enemyEntity.baseComponent,enemyEntity.roleComponent);\n        }.bind(this), bulletBaseComponent.gameObject);\n        \n        var end_func = cc.callFunc(function(){\n            bulletRoleComponent.isDead=true;\n            bulletAttackComponent.enemyID=0;\n            //bulletBaseComponent.gameObject.removeFromParent();\n        }.bind(this), bulletBaseComponent.gameObject);\n        var seq = cc.sequence([bto_action, func, cc.delayTime(1), cc.fadeOut(0.3), end_func]);\n        bulletBaseComponent.gameObject.runAction(seq);\n        // 逻辑与图像分离\n        var degree;\n        if (bulletAnimateComponent.dstPos.x < bulletAnimateComponent.srcPos.x) { // 在左边\n            degree = -180 + Math.random() * 10;\n        }\n        else {\n            degree = 180 - Math.random() * 10;\n        }\n        var rot = cc.rotateBy(time, degree);\n        anim.runAction(rot);\n\n        bulletAnimateComponent.state=AnimateState.stop;\n    }\n}\n"]}