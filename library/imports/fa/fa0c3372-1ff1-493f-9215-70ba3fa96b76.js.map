{"version":3,"sources":["assets\\Scripts\\ECS\\Systems\\AnimateSystem.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/life-cycle-callbacks.html\n\nimport GameDataManager from \"../../Data/GameDataManager\";\nimport AnimateComponent from \"../Components/AnimateComponent\";\nimport AttackComponent from \"../Components/AttackComponent\";\nimport BaseComponent from \"../Components/BaseComponent\";\nimport RoleComponent from \"../Components/RoleComponent\";\nimport ECSManager from \"../ECSManager\";\nimport ECSUtil from \"../ECSUtil\";\nimport EnemyEntity from \"../Entities/EnemyEntity\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class AnimateSystem extends cc.Component {\n\n    private static _instance:AnimateSystem=null\n    onLoad () {\n        if(null===AnimateSystem._instance){\n            AnimateSystem._instance=this\n        }\n        else{\n            this.destroy()\n            return\n        }\n    }\n\n    public static getInstance():AnimateSystem{\n        return AnimateSystem._instance;\n    }\n\n    onBulletUpdate(dt:number,bulletRoleComponent:RoleComponent,bulletAnimateComponent:AnimateComponent,\n        bulletAttackComponent:AttackComponent,bulletBaseComponent:BaseComponent){\n        let speed = GameDataManager.getInstance().arrow_bullet_params[bulletRoleComponent.level - 1].speed;\n        let attack = GameDataManager.getInstance().arrow_bullet_params[bulletRoleComponent.level - 1].attack;\n        let enemyEntity:EnemyEntity=ECSManager.getInstance().getEnemyEntityByID(bulletAttackComponent.enemyID);\n        let shoot_enemy = enemyEntity.baseComponent.gameObject;//enemy;\n        let anim=bulletBaseComponent.gameObject.getChildByName(\"anim\")\n        var start_pos = bulletBaseComponent.gameObject.parent.convertToNodeSpaceAR(bulletAnimateComponent.srcPos);\n        var dst_pos = bulletBaseComponent.gameObject.parent.convertToNodeSpaceAR(bulletAnimateComponent.dstPos);\n        \n        // 发射的时候调整我们角度,设置好位置\n        bulletBaseComponent.gameObject.setPosition(start_pos);\n        anim.angle = 90;\n        // end  \n        // 创建一个贝塞尔的action来控制我们的子弹的发射\n        // var dir = cc.pSub(w_dst_pos, w_start_pos);\n        var dir = bulletAnimateComponent.dstPos.sub(bulletAnimateComponent.srcPos);\n\n        // var len = cc.pLength(dir);\n        var len = (dir.mag());\n        var time = len / speed;\n\n        var after_pos = cc.v2(29,-29);//actor.position_after_time(time);\n        let w_dst_pos = shoot_enemy.convertToWorldSpaceAR(after_pos);\n        dst_pos = bulletBaseComponent.gameObject.parent.convertToNodeSpaceAR(w_dst_pos);\n        // end \n        // 求贝塞尔曲线的控制点，中点，然后拉高xxxxx\n        var ctrl_x;\n        var ctrl_y;\n        \n        // if (Math.abs(dir.x) <= 10 && dir.y < 0) {\n        if (0) {\n            ctrl_y = (start_pos.y + dst_pos.y) * 0.5;\n            if (start_pos.x > dst_pos.x) {\n                ctrl_x = dst_pos.x;\n                // ctrl_x -= 20;\n            }\n            else {\n                ctrl_x = dst_pos.x;\n                // ctrl_x += 20;\n            }\n        }\n        else {\n            ctrl_x = (start_pos.x + dst_pos.x) * 0.5;\n            ctrl_y = (dst_pos.y > start_pos.y) ? dst_pos.y : start_pos.y;\n            ctrl_y += 40;\n        }\n        // end \n        var ctrl_point_set = [cc.v2(ctrl_x, ctrl_y), cc.v2(ctrl_x, ctrl_y), dst_pos];\n        var bto_action = cc.bezierTo(time, ctrl_point_set);\n        // this.node.runAction(bto_action); // 发射到目标点;\n        // 换图，把这个完整的键，换成我们的半截键\n        var func = cc.callFunc(function(){\n            var s = anim.getComponent(cc.Sprite);\n            //s.spriteFrame = this.decal_arrow_sprite_frame;\n            ECSUtil.getInstance().on_bullet_shoot(attack,enemyEntity.unitComponent,enemyEntity.baseComponent,enemyEntity.roleComponent);\n        }.bind(this), bulletBaseComponent.gameObject);\n        \n        var end_func = cc.callFunc(function(){\n            bulletRoleComponent.isDead=true;\n            bulletAttackComponent.enemyID=0;\n            //bulletBaseComponent.gameObject.removeFromParent();\n        }.bind(this), bulletBaseComponent.gameObject);\n        var seq = cc.sequence([bto_action, func, cc.delayTime(3), cc.fadeOut(0.3), end_func]);\n        bulletBaseComponent.gameObject.runAction(seq);\n        // 逻辑与图像分离\n        var degree;\n        if (bulletAnimateComponent.dstPos.x < bulletAnimateComponent.srcPos.x) { // 在左边\n            degree = -180 + Math.random() * 10;\n        }\n        else {\n            degree = 180 - Math.random() * 10;\n        }\n        var rot = cc.rotateBy(time, degree);\n        anim.runAction(rot);\n    }\n}\n"]}