{"version":3,"sources":["assets\\Scripts\\ECS\\Systems\\AISystem.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/life-cycle-callbacks.html\n\nimport { ResManagerPro } from \"../../../FrameWork/manager/ResManagerPro\";\nimport GameDataManager from \"../../Data/GameDataManager\";\nimport { AnimateState, RoleState, TowerType } from \"../../Enum\";\nimport FrameAnimate from \"../../Tools/FrameAnimate\";\nimport AIComponent from \"../Components/AIComponent\";\nimport AnimateComponent from \"../Components/AnimateComponent\";\nimport AttackComponent from \"../Components/AttackComponent\";\nimport BaseComponent from \"../Components/BaseComponent\";\nimport NavComponent from \"../Components/NavComponent\";\nimport RoleComponent from \"../Components/RoleComponent\";\nimport TransformComponent from \"../Components/TransformComponent\";\nimport UnitComponent from \"../Components/UnitComponent\";\nimport ECSUtil from \"../ECSUtil\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class AISystem extends cc.Component {\n\n    private static _instance:AISystem=null\n    onLoad () {\n        if(null===AISystem._instance){\n            AISystem._instance=this\n        }\n        else{\n            this.destroy()\n            return\n        }\n    }\n\n    public static getInstance():AISystem{\n        return AISystem._instance;\n    }\n\n    onTowerUpdate(dt:number,towerAnimateComponent:AnimateComponent,towerRoleComponent:RoleComponent,towerAttackComponent:AttackComponent,\n        towerBaseComponent,enemyTransformComponent:TransformComponent,enemyBaseComponent:BaseComponent){\n        \n        if(towerRoleComponent.type==TowerType.Infantry){\n            towerAttackComponent.activeTime=4.0;\n            towerAnimateComponent.state=AnimateState.Start;\n        }\n        else{\n            var src = towerBaseComponent.gameObject.convertToWorldSpaceAR(cc.v2(0,0))\n            var search_R = GameDataManager.getInstance().arrow_tower_params[towerRoleComponent.level - 1].search_R;\n            var dst = enemyBaseComponent.gameObject.convertToWorldSpaceAR(cc.v2(0,0))\n            var dir = dst.sub(src);\n            if (search_R >= (dir.mag())) {\n                // 攻击\n                towerAttackComponent.activeTime=1.0;\n                towerAnimateComponent.id=enemyBaseComponent.entityID;\n                towerAnimateComponent.dstPos=dst;\n                towerAnimateComponent.state=AnimateState.Start;\n                return true\n            }\n        }\n        \n        return false\n    }\n\n    async onInfantryActorUpdate(dt:number,\n        actorAIComponent:AIComponent,actorBaseComponent:BaseComponent,actorTransformComponent:TransformComponent,\n        actorNavComponent:NavComponent,actorRoleComponent:RoleComponent,\n        enemyUnitComponent:UnitComponent,enemyBaseComponent:BaseComponent,enemyRoleComponent:RoleComponent){\n        var src = actorBaseComponent.gameObject.convertToWorldSpaceAR(cc.v2(0,0))\n        var attack_R = actorAIComponent.attack_R;\n        let search_R = actorAIComponent.search_R;\n        var dst = enemyBaseComponent.gameObject.convertToWorldSpaceAR(cc.v2(0,0))\n        var dir = dst.sub(src);\n        if (attack_R >= (dir.mag())) {// 攻击\n            actorAIComponent.thinkTime=1;\n            // 播放攻击动画\n            let anim=actorBaseComponent.gameObject.getChildByName(\"anim\");\n            var frame_anim = anim.addComponent(FrameAnimate);\n            let walk_anim:cc.SpriteFrame[]=new Array();\n            for(let i=0;i<3;i++){\n                let frame=await ResManagerPro.Instance.IE_GetAsset(\"textures\",\"game_scene/tower/bing_tower/actor1/attack/attack1_\"+i,cc.SpriteFrame) as cc.SpriteFrame;\n                walk_anim.push(frame);\n            }\n            frame_anim.sprite_frames = walk_anim;\n            frame_anim.duration = 0.1;\n            frame_anim.play_once(function(){\n                actorRoleComponent.state=RoleState.Dead\n            });\n\n            ECSUtil.getInstance().on_arrowBullet_shoot(10,enemyUnitComponent,enemyBaseComponent,enemyRoleComponent);\n        }\n        else if(search_R>=(dir.mag())){//追击\n            let dx=dst.x-src.x;\n            let dy=dst.y-src.y;\n            let dis=Math.sqrt(dx*dx+dy*dy);\n            let vx=dx/dis*actorNavComponent.speed;\n            let vy=dy/dis*actorNavComponent.speed;\n\n            actorBaseComponent.gameObject.x=vx*dt+actorTransformComponent.x;\n            actorBaseComponent.gameObject.y=vy*dt+actorTransformComponent.y;\n            actorTransformComponent.x=actorBaseComponent.gameObject.x;\n            actorTransformComponent.y=actorBaseComponent.gameObject.y;\n\n            if (vx < 0) {\n                actorBaseComponent.gameObject.getChildByName(\"anim\").scaleX = -1;\n            }\n            else {\n                actorBaseComponent.gameObject.getChildByName(\"anim\").scaleX = 1;\n            }\n        }\n    }\n}\n"]}